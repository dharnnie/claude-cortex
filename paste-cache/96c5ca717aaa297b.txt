# Contributing Guidelines

## Git Workflow

### Branch Naming
```bash
# Feature branches
feature/add-user-authentication
feature/wallet-transactions

# Bug fixes
fix/order-validation-error
fix/null-pointer-in-payments

# Refactoring
refactor/extract-payment-service
refactor/optimize-queries

# Chores (dependencies, CI, docs)
chore/update-rails-8
chore/add-ci-workflow
```

### Commit Messages
Follow [Conventional Commits](https://www.conventionalcommits.org/):

```bash
# Format
<type>(<scope>): <description>

# Types
feat:     New feature
fix:      Bug fix
refactor: Code change (no new feature or fix)
test:     Adding/updating tests
docs:     Documentation only
chore:    Maintenance (deps, CI, configs)
perf:     Performance improvement

# Examples
feat(wallets): add balance transfer endpoint
fix(orders): validate quantity before save
refactor(auth): extract token service
test(users): add registration edge cases
chore(deps): bump rails to 8.0.1
```

### Commit Best Practices
- Write in imperative mood: "add feature" not "added feature"
- Keep subject line under 72 characters
- One logical change per commit
- Never commit broken code to main

## Pull Requests

### Before Opening PR
```bash
# 1. Ensure tests pass
bin/rspec

# 2. Run linter and fix issues
bin/rubocop -a

# 3. Check for security issues
bin/brakeman -q

# 4. Rebase on latest main
git fetch origin
git rebase origin/main
```

### PR Requirements
- Descriptive title following commit message format
- Description explaining **what** and **why**
- Link to related issue if applicable
- All CI checks passing
- Test coverage for new code
- No commented-out code
- No debug statements (puts, debugger, binding.pry)

### PR Template
```markdown
## What
Brief description of changes.

## Why
Context and motivation.

## How
Implementation approach (if non-obvious).

## Testing
- [ ] Added/updated unit tests
- [ ] Added/updated request specs (for API changes)
- [ ] Manually tested locally

## Checklist
- [ ] Tests pass (`bin/rspec`)
- [ ] Linter passes (`bin/rubocop`)
- [ ] No N+1 queries introduced
- [ ] Migrations are reversible
- [ ] Secrets not committed
```

## Code Review

Use `/review` to get an automated review against project conventions:
```bash
/review 123              # Review PR #123
/review feature/my-feat  # Review branch against main
/review                  # Review current changes
```

### Reviewer Checklist
- [ ] Code follows project conventions
- [ ] Tests cover happy path and edge cases
- [ ] No security vulnerabilities (SQL injection, mass assignment)
- [ ] Queries scoped to current user where applicable
- [ ] No N+1 queries
- [ ] Database indexes for new foreign keys
- [ ] Error handling is appropriate
- [ ] No over-engineering

### Review Etiquette
- Be constructive and specific
- Explain the "why" behind suggestions
- Approve when changes are minor
- Use conventional comments:
  ```
  nit: minor style suggestion
  suggestion: optional improvement
  question: seeking clarification
  issue: must be addressed
  ```

## Database Changes

### Migration Checklist
- [ ] Add indexes for foreign keys
- [ ] Add indexes for columns in WHERE/ORDER BY
- [ ] Use `null: false` where appropriate
- [ ] Provide default values when sensible
- [ ] Migration is reversible (`change` or `up/down`)
- [ ] Large tables: use `disable_ddl_transaction!` if needed

### Safe Migrations
```ruby
# Add column with default (safe in Rails 8+)
add_column :users, :active, :boolean, default: true, null: false

# Add index concurrently for large tables
disable_ddl_transaction!

def change
  add_index :orders, :status, algorithm: :concurrently
end
```

## Planning Before Implementation

**Think before coding.** For non-trivial features, always plan before implementing.

### When to Plan

Use Plan Mode for:
- New features touching multiple files
- Architectural decisions (new patterns, libraries, integrations)
- Complex refactors
- Unclear requirements that need exploration
- Any change where the approach isn't obvious

Skip planning for:
- Single-file bug fixes
- Typo corrections
- Simple, well-defined changes

### How to Use Plan Mode

**Enter Plan Mode:**
- Press `Shift+Tab` to cycle modes until you see `plan mode on`
- Or start session with: `claude --permission-mode plan`

**In Plan Mode, Claude will:**
1. Explore the codebase (read-only, no edits)
2. Ask clarifying questions
3. Propose a detailed implementation plan
4. Wait for your approval

**After approval:**
- Press `Shift+Tab` to switch back to Normal Mode
- Ask Claude to implement the approved plan

### Plan Structure

A good plan includes:
```markdown
## Goal
What we're trying to achieve

## Approach
High-level strategy

## Files to Change
- path/to/file.rb - What changes and why
- path/to/another.rb - What changes and why

## New Files (if any)
- path/to/new_file.rb - Purpose

## Dependencies
- External gems or services needed
- Migration requirements

## Testing Strategy
- What to test and how

## Risks & Considerations
- Edge cases
- Performance implications
- Security concerns
```

### Claude Code Instructions

When asked to implement a feature, Claude should:
1. **Assess complexity** - Is this trivial or multi-step?
2. **For non-trivial work** - Explore first, propose a plan, wait for approval
3. **For trivial work** - Proceed directly with implementation
4. **Never assume** - Ask clarifying questions when requirements are ambiguous

## Feature Development Flow

1. **Start feature** with `/feature <name>` (creates branch from latest `main`)
   ```bash
   # Or manually:
   git fetch origin && git checkout -b feature/<name> origin/main
   ```
2. **Plan** (for non-trivial features) - Use Plan Mode, get approval
3. **Write failing test** for the feature
4. **Implement** the feature (or have Claude implement the approved plan)
5. **Refactor** if needed
6. **Run full test suite** (`bin/rspec`)
7. **Run linter** (`bin/rubocop -a`)
8. **Review** with `/review` before pushing
9. **Push and open PR**
10. **Address review feedback**
11. **Squash and merge** when approved

## Hotfix Flow

1. Branch from `main`: `fix/critical-bug-name`
2. Fix with minimal changes
3. Add regression test
4. Fast-track review
5. Merge and deploy

## CI Requirements

All PRs must pass:
- `bin/rspec` - Test suite
- `bin/rubocop` - Code style
- `bin/brakeman` - Security scan
- `bundle audit` - Dependency vulnerabilities
